<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Visualization API Demo</title>
    <link rel="stylesheet" href="/static/animations.css">
    <link rel="stylesheet" href="/static/demo.css">
</head>
<body>
    <div class="container">
        <div class="demo-container">
            <div id="control-panel" class="control-panel">
                <h1>Chart Visualization API Demo</h1>

                <form id="chartForm">
                    {# <div class="example-section">
                        <h4>Examples</h4>
                        <div class="example-buttons" id="exampleSmiles">
                            <button
                                class="example-btn"
                                data-name="bar-basic"
                            >
                                Bassic bar chart
                            </button>
                            <button
                                class="example-btn"
                                data-name="line-ticker"
                            >
                                Stock tickers line chart
                            </button>
                            <button
                                class="example-btn"
                                data-name="line-ticker"
                            >
                                Revenue pie
                            </button>
                        </div>
                    </div> #}

                    <div class="url-preview" id="urlPreview">
                        URL will appear here
                        <button class="copy-btn" id="copyUrlBtn">
                            Copy
                        </button>
                    </div>
                    
                    <div class="btn-wrap">
                        <button type="submit" id="update-preview-btn-1">Update Preview</button>
                        <button id="open-btn-1">Open URL</button>
                    </div>

                    <h3>Chart Input</h3>
                    <div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" name="title" value="Demo Chart" required />
                    </div>

                    <div class="form-group">
                        <label for="subtitle">Subtitle:</label>
                        <input type="text" id="subtitle" name="subtitle" value="Some subtitle" required />
                    </div>

                    <div class="form-group">
                        <label for="body">Body:</label>
                        <textarea id="body" name="body" rows="4" required>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse molestie quam erat, suscipit fringilla turpis feugiat sit amet. Donec iaculis convallis viverra. Pellentesque vel diam et velit molestie vulputate id sed dolor. Praesent et turpis mauris. Duis eget libero pretium, laoreet sapien sed, interdum erat. Nulla pretium, nunc et ultrices scelerisque, sapien urna lacinia ex, sed venenatis magna metus id sapien. Suspendisse cursus ligula ac dolor fermentum, id maximus nisl condimentum.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="labels">Labels (comma-separated values):</label>
                        <input type="text" id="labels" name="labels" value="January,February,March" required />
                    </div>

                    <div class="form-group">
                        <label for="datasets">Datasets (comma-separated values for each dataset):</label>
                        <div id="datasets-container">
                            {# Datasets are dynamically added here by addDataset() #}
                        </div>
                        <button type="button" id="add-dataset">Add Dataset</button>
                    </div>

                    <h3>Rendering Options</h3>
                    <div class="form-group">
                        <label for="width">Width (pixels):</label>
                        <input type="number" id="width" name="width" value="600" min="100" />
                    </div>

                    <div class="form-group">
                        <label for="height">Height (pixels):</label>
                        <input type="number" id="height" name="height" value="400" min="100" />
                    </div>

                    <div class="form-group">
                        <label for="style">Style:</label>
                        <select id="style" name="style">
                            <option value="A" selected>Style A</option>
                            <option value="B">Style B</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="render-type">Render Type:</label>
                        <select id="render-type" name="render-type">
                            <option value="Interactive" selected>Interactive</option>
                            <option value="PNG">PNG</option>
                        </select>
                    </div>

                    <div class="form-group" id="scale-option" style="display:none">
                        <label for="scale">PNG Scale:</label>
                        <input type="number" id="scale" name="scale" value="2" min="1" />
                    </div>

                    <div class="btn-wrap">
                        <button type="submit" id="update-preview-btn-2">Update Preview</button>
                        <button id="open-btn-2">Open URL</button>
                    </div>
                </form>
            </div>

            <div class="preview-panel">
                <iframe id="previewFrame" title="Chart Visualization"></iframe>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("chartForm");
            const previewFrame = document.getElementById("previewFrame");
            const urlPreview = document.getElementById("urlPreview");
            const copyUrlBtn = document.getElementById("copyUrlBtn");
            const scaleOption = document.getElementById("scale-option");
            const datasetsContainer = document.getElementById("datasets-container");
            const addDatasetButton = document.getElementById("add-dataset");
            const updatePreviewBtn1 = document.getElementById("update-preview-btn-1");
            const updatePreviewBtn2 = document.getElementById("update-preview-btn-2");
            const openBtn1 = document.getElementById("open-btn-1");
            const openBtn2 = document.getElementById("open-btn-2");

            // Function to update the iframe with chart data
            function updatePreview() {
                const title = document.getElementById("title").value;
                const subtitle = document.getElementById("subtitle").value;
                const body = document.getElementById("body").value;
                const labels = document.getElementById("labels").value.split(",").map(label => label.trim());
                const style = document.getElementById("style").value;
                const width = document.getElementById("width").value;
                const height = document.getElementById("height").value;
                const renderType = document.getElementById("render-type").value;
                const scale = document.getElementById("scale").value;

                const datasets = Array.from(datasetsContainer.children).map(dataset => {
                    return {
                        label: dataset.querySelector(".dataset-label").value,
                        data: dataset.querySelector(".dataset-values").value.split(",").map(value => parseInt(value.trim(), 10))
                    };
                });

                const data = { labels, datasets, title };

                const encodedData = encodeURIComponent(JSON.stringify(data));
                const url = `/chart${renderType == 'PNG' ? '/png' : ''}?data=${encodedData}&width=${width}&height=${height}&scale=${scale}&title=${encodeURIComponent(title)}&subtitle=${encodeURIComponent(subtitle)}&body=${encodeURIComponent(body)}`;

                // Update preview URL
                urlPreview.textContent = window.location.origin + url;
                urlPreview.appendChild(copyUrlBtn);

                // Update the iframe src
                previewFrame.src = url;
            }

            // Copy URL button
            copyUrlBtn.addEventListener("click", () => {
                const url = urlPreview.textContent
                    .replace("Copy", "")
                    .trim()
                navigator.clipboard.writeText(url).then(() => {
                    const originalText = copyUrlBtn.textContent
                    copyUrlBtn.textContent = "Copied!"
                    setTimeout(() => {
                        copyUrlBtn.textContent = originalText
                    }, 2000)
                })
            })

            // Update when inputs change (for real-time preview)
            form.addEventListener("input", () => {
                // updatePreview()
                updatePreviewBtn1.classList.add('tense')
                updatePreviewBtn2.classList.add('tense')
                
                // Toggle PNG scale depending on render type
                const controlPanel = document.getElementById("control-panel")
                const renderType = document.getElementById("render-type").value;
                if (renderType === "PNG") {
                    scaleOption.style.display = "block";
                    controlPanel.scrollTo(0, controlPanel.scrollHeight);
                } else {
                    scaleOption.style.display = "none";
                }
            })

            // Update on form submit
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                updatePreviewBtn1.classList.remove('tense')
                updatePreviewBtn2.classList.remove('tense')
                updatePreview();
            });

            // Open URL buttons
            openBtn1.addEventListener("click", openUrl)
            openBtn2.addEventListener("click", openUrl)
            function openUrl(e) {
                const url = urlPreview.textContent.replace("Copy", "").trim()
                window.open(url)
            }

            function addDataset() {
                const index = datasetsContainer.children.length + 1;
                const datasetDiv = document.createElement("div");
                datasetDiv.className = "dataset";

                const labelInput = document.createElement("input");
                labelInput.type = "text";
                labelInput.className = "dataset-label";
                labelInput.placeholder = `Dataset ${index} label`;
                labelInput.value = `Dataset ${index}`;

                const valuesInput = document.createElement("input");
                valuesInput.type = "text";
                valuesInput.className = "dataset-values";
                valuesInput.placeholder = "Comma-separated values";

                // Generate random values based on the number of labels
                const labels = document.getElementById("labels").value.split(",").map(label => label.trim());
                const randomValues = labels.map(() => Math.floor(Math.random() * 100) + 1);
                valuesInput.value = randomValues.join(",");

                datasetDiv.appendChild(labelInput);
                datasetDiv.appendChild(valuesInput);
                datasetsContainer.appendChild(datasetDiv);
            }

            // Add three default datasets on startup
            addDataset();
            addDataset();
            addDataset();

            addDatasetButton.addEventListener("click", () => {
                addDataset();
                updatePreview();
            });

            // Initially update the preview with default values
            updatePreview();
        });
    </script>
</body>
</html>
