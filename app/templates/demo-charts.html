<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Visualization API Demo</title>
    <link rel="stylesheet" href="/static/animations.css">
    <link rel="stylesheet" href="/static/demo.css">
</head>
<body>
    <div class="container">
        <div class="demo-container">
            <div id="control-panel" class="control-panel">
                <h1>Chart Visualization API Demo</h1>

                <h3>Examples</h3>
                <div class="example-section">
                    <label for="example-select">Choose/edit sample data:</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <select id="example-select" name="example-select">
                            <optgroup label="Bar Charts">
                                <option data-url="/generate/bar" data-chart-type="bar" data-params="{}">Bar chart</option>
                                <option data-url="/generate/bar" data-chart-type="bar" data-params='{"h":1}'>Bar chart horizontal</option>
                                <option data-url="/generate/bar" data-chart-type="bar" data-params='{"barmode":"stack"}'>Bar chart stacked</option>
                            </optgroup>
                            <optgroup label="Line Charts">
                                <option data-url="/generate/line" data-chart-type="line" data-params="{}">Line chart</option>
                                <option data-url="/generate/line" data-chart-type="line" data-params='{"h":1}'>Line chart horizontal</option>
                            </optgroup>
                            <optgroup label="Scatter Plots">
                                <option data-url="/generate/scatter" data-chart-type="scatter" data-params="{}">Scatter plot</option>
                            </optgroup>
                            <optgroup label="Bubble Charts">
                                <option data-url="/generate/bubble" data-chart-type="bubble" data-params="{}">Bubble chart</option>
                            </optgroup>
                            <optgroup label="Pie Charts">
                                <option data-url="/generate/pie" data-chart-type="pie" data-params="{}">Pie chart</option>
                            </optgroup>
                            <optgroup label="Box Plots">
                                <option data-url="/generate/boxplot" data-chart-type="boxplot" data-params="{}">Box plot basic</option>
                                <option data-url="/generate/boxplot" data-chart-type="boxplot" data-params='{"group":1}'>Box plot grouped</option>
                                <option data-url="/generate/boxplot" data-chart-type="boxplot" data-params='{"h":1}'>Box plot horizontal</option>
                                <option data-url="/generate/boxplot" data-chart-type="boxplot" data-params='{"show_points":1}'>Box plot + data points</option>
                                <option data-url="/generate/boxplot" data-chart-type="boxplot" data-params='{"boxmean":1}'>Box plot + mean deviation</option>
                                <option data-url="/generate/boxplot" data-chart-type="boxplot" data-params='{"boxmean":"sd"}'>Box plot + standard deviation</option>
                            </optgroup>
                            <optgroup label="Histogram Charts">
                                <option data-url="/generate/histogram" data-chart-type="histogram" data-params="{}">Histogram chart</option>
                                <option data-url="/generate/histogram" data-chart-type="histogram" data-params='{"h":1}'>Histogram chart horizontal</option>
                                <option data-url="/generate/histogram" data-chart-type="histogram" data-params='{"barmode":"stack"}'>Histogram chart stacked</option>
                            </optgroup>
                        </select>
                        <!-- Apply button removed: example is generated when dropdown changes (and on initial load) -->
                    </div>

                    <textarea id="data-preview"></textarea>
                    
                    <!-- changed to type="button" so it doesn't trigger the form submit handler -->
                    <button type="button" id="generate-chart-btn">Generate chart</button>

                </div>
                
                <form id="chart-form">
                    <div id="url-preview">
                        <pre id="url-preview-text"></pre>
                        <button class="copy-btn" id="copy-url-btn" type="button">Copy</button>
                    </div>
 					
 					<div class="btn-wrap">
 						<button id="open-btn-1" type="button" style="display:none">Open URL</button>
 						<button type="submit" id="update-btn-1" class="tense" style="display:none">Update</button>
 					</div>
 
 					<h3>Display Options</h3>
 					<div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" name="title" value="Demo Chart" required />
                    </div>

                    <div class="form-group">
                        <label for="subtitle">Subtitle:</label>
                        <input type="text" id="subtitle" name="subtitle" value="Some subtitle" required />
                    </div>

                    <div class="form-group">
                        <label for="body">Body:</label>
                        <textarea id="body" name="body" rows="4" required>Hello world</textarea>
                    </div>

                    <!-- Added axis titles / prefixes / suffixes -->
                    <div class="form-group">
                        <label for="x_title">X axis title:</label>
                        <input type="text" id="x_title" name="x_title" value="" />
                    </div>

                    <div class="form-group">
                        <label for="y_title">Y axis title:</label>
                        <input type="text" id="y_title" name="y_title" value="" />
                    </div>

                    <div class="form-group">
                        <label for="x_prefix">X axis prefix:</label>
                        <input type="text" id="x_prefix" name="x_prefix" value="" />
                    </div>

                    <div class="form-group">
                        <label for="y_prefix">Y axis prefix:</label>
                        <input type="text" id="y_prefix" name="y_prefix" value="" />
                    </div>

                    <div class="form-group">
                        <label for="x_suffix">X axis suffix:</label>
                        <input type="text" id="x_suffix" name="x_suffix" value="" />
                    </div>

                    <div class="form-group">
                        <label for="y_suffix">Y axis suffix:</label>
                        <input type="text" id="y_suffix" name="y_suffix" value="" />
                    </div>

                    <h3>Rendering Options</h3>
                    <div class="form-group">
                        <label for="width">Width (pixels):</label>
                        <input type="text" id="width" name="width" value="" />
                    </div>

                    <div class="form-group">
                        <label for="height">Height (pixels):</label>
                        <input type="text" id="height" name="height" value="" />
                    </div>

                    <div class="form-group">
                        <label for="omit_legend">Omit legend:</label>
                        <select id="omit_legend" name="omit_legend">
                            <option value="">No</option>
                            <option value="1">Yes</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="output">Output:</label>
                        <select id="output" name="output">
                            <option value="" selected>HTML</option>
                            <option value="png">PNG</option>
                            <option value="svg">SVG</option>
                        </select>
                    </div>

                    <div class="form-group" id="scale-option" style="display:none">
                        <label for="scale">PNG Scale:</label>
                        <input type="number" id="scale" name="scale" value="2" min="1" />
                    </div>

                    <div class="btn-wrap">
                        <button id="open-btn-2">Open URL</button>
                        <button type="submit" id="update-btn-2" class="tense" style="display:none">Update</button>
                    </div>
                </form>
            </div>

            <div class="preview-panel">
                <iframe id="preview-frame" title="Chart Visualization"></iframe>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("chart-form");
            const previewFrame = document.getElementById("preview-frame");
            const dataPreview = document.getElementById("data-preview");
            const urlPreview = document.getElementById("url-preview");
            const urlPreviewText = document.getElementById("url-preview-text");
            const copyUrlBtn = document.getElementById("copy-url-btn");
            const scaleOption = document.getElementById("scale-option");
            const updateBtn1 = document.getElementById("update-btn-1");
            const updateBtn2 = document.getElementById("update-btn-2");
            const openBtn1 = document.getElementById("open-btn-1");
            const openBtn2 = document.getElementById("open-btn-2");

            // Function to update the iframe with chart data
            function updatePreview(path=null, qParams={}) {
                // If no URL is passed, create base URL
                if (!path) {
                    let currentUrl = urlPreviewText.textContent.trim()
                    try {
                        currentUrl = new URL(currentUrl);
                        path = currentUrl.pathname;
                    } catch(err) {
                        alert("Current URL is invalid, please regenerate chart")
                        return false
                    }
                }

                // Chart input
                qParams.title = document.getElementById("title").value;
                qParams.subtitle = document.getElementById("subtitle").value;
                qParams.body = document.getElementById("body").value;
                qParams.x_title = document.getElementById("x_title").value;
                qParams.y_title = document.getElementById("y_title").value;
                qParams.x_prefix = document.getElementById("x_prefix").value;
                qParams.y_prefix = document.getElementById("y_prefix").value;
                qParams.x_suffix = document.getElementById("x_suffix").value;
                qParams.y_suffix = document.getElementById("y_suffix").value;

                // Render options
                qParams.width = document.getElementById("width").value;
                qParams.height = document.getElementById("height").value;
                qParams.output = document.getElementById("output").value;
                if (qParams.output == 'png') {
                    qParams.scale = document.getElementById("scale").value;
                }
                qParams.omit_legend = document.getElementById("omit_legend").value;

                // Filter out empty values
                for (const key in qParams) {
                    console.log(key, qParams[key], !qParams[key])
                    if (!qParams[key]) delete qParams[key]
                }

                // Compile URL
                qParams = new URLSearchParams(qParams)
                qParamsStr = qParams.toString()
                if (qParamsStr) {
                    path += `?${qParamsStr}`
                }

                // Update preview URL (displayed in the <pre> to preserve indentation)
                urlPreviewText.textContent = window.location.origin + path;
                // ensure copy button remains inside container
                if (!urlPreview.contains(copyUrlBtn)) urlPreview.appendChild(copyUrlBtn);

                // Update the iframe src
                previewFrame.src = path;

                openBtn1.style.display = "inline-block"
                openBtn2.style.display = "inline-block"

                return true
            }

            // Copy URL button
            copyUrlBtn.addEventListener("click", () => {
                const url = (urlPreviewText && urlPreviewText.textContent) ? urlPreviewText.textContent.trim() : ''
                navigator.clipboard.writeText(url).then(() => {
                    const originalText = copyUrlBtn.textContent
                    copyUrlBtn.textContent = "âœ… Copied"
                    setTimeout(() => {
                        copyUrlBtn.textContent = originalText
                    }, 2000)
                })
            })

            // Shake update button when inputs change (for real-time preview)
            form.addEventListener("input", () => {
                // Toggle PNG scale only if output is 'png'
 				const controlPanel = document.getElementById("control-panel")
 				const output = document.getElementById("output").value;
 				if (output === "png") {
 					scaleOption.style.display = "block";
 					controlPanel.scrollTo(0, controlPanel.scrollHeight);
 				} else {
 					scaleOption.style.display = "none";
 				}

                // Show "Update" buttons
                if (urlPreviewText.textContent) {
                    updateBtn1.style.display = "inline-block"
                    updateBtn2.style.display = "inline-block"
                }
                
            })

            // Update preview buttons
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                updateBtn1.style.display = "none"
                updateBtn2.style.display = "none"
                updatePreview();
            });

            // Open URL buttons
            openBtn1.addEventListener("click", openUrl)
            openBtn2.addEventListener("click", openUrl)
            function openUrl(e) {
                const success = updatePreview();
                if (success) {
                    const url = (urlPreviewText && urlPreviewText.textContent) ? urlPreviewText.textContent.trim() : ''
                    window.open(url)
                }
            }

            // Initially update the preview with default values
            // updatePreview();

			// Example dropdown
			const exampleSelect = document.getElementById("example-select");
			// Fetch example JSON from /generate/{chart_type} and display it in #url-preview (inside <pre>)
 			async function fetchAndShowExample(opt) {
 				if (!opt) return;
 				// Derive chart type from data-url (e.g. "/generate/bar" -> "bar")
 				const urlPath = opt.dataset.url || '/generate/bar';
 				const parts = urlPath.split('/').filter(Boolean);
 				const chartType = parts.length ? parts.pop() : 'bar';

 				// Fetch generated example JSON
 				try {
 					const resp = await fetch(`/generate/${encodeURIComponent(chartType)}`);
 					const json = await resp.json();
 					// Display JSON with indent=2
                    dataPreview.value = JSON.stringify(json, null, 2);
					
 				} catch (err) {
					const errMsg = `Error fetching example for "${chartType}": ${err.message || err}`;
					if (urlPreviewText) urlPreviewText.textContent = errMsg; else urlPreview.textContent = errMsg;
 				}
 				// Ensure copy button remains available
				if (!urlPreview.contains(copyUrlBtn)) urlPreview.appendChild(copyUrlBtn);
 			}

 			// Trigger fetch when dropdown changes
 			exampleSelect.addEventListener('change', () => {
 				const opt = exampleSelect.options[exampleSelect.selectedIndex];
 				// Clear previous URL preview and hide open buttons when selecting a new example
				if (urlPreviewText) urlPreviewText.textContent = '';
				if (openBtn1) openBtn1.style.display = 'none';
				if (openBtn2) openBtn2.style.display = 'none';
				fetchAndShowExample(opt);
 			});

 			// Execute once on initial load for the first (default) option
 			const initialOpt = exampleSelect.options[exampleSelect.selectedIndex] || exampleSelect.options[0];
 			fetchAndShowExample(initialOpt);

			// Generate chart button - POST JSON from data-preview to /chart/{chart_type}
			const generateBtn = document.getElementById("generate-chart-btn");
			generateBtn.addEventListener("click", async (e) => {
				e.preventDefault();
				// get selected option and chart type (prefer data-chart-type)
				const opt = exampleSelect.options[exampleSelect.selectedIndex];
				const chartType = (opt && opt.dataset && opt.dataset.chartType) ? opt.dataset.chartType : (opt && opt.dataset && opt.dataset.url ? opt.dataset.url.split('/').filter(Boolean).pop() : 'bar');

				// read payload from textarea
				const payloadStr = (dataPreview && dataPreview.value) ? dataPreview.value.trim() : '';
				if (!payloadStr) {
					// throw an error as requested (also show an alert for UX)
					alert('No data present in the data-preview textarea.');
					throw new Error('No data present in data-preview');
				}

				// validate JSON
				let payload;
				try {
					payload = JSON.parse(payloadStr);
				} catch (err) {
					alert('Invalid JSON in data-preview textarea.');
					return;
				}

				// POST to /chart/{chart_type}
				try {
					const resp = await fetch(`/chart/${encodeURIComponent(chartType)}`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});
					if (!resp.ok) {
						const txt = await resp.text();
						throw new Error(txt || resp.statusText || 'Server error');
					}
					const json = await resp.json();
					if (json && json.url) {
						// reuse updatePreview to show the returned url and update iframe
						updatePreview(json.url, {});
					} else {
						throw new Error('Invalid response from server');
					}
				} catch (err) {
					const msg = err && err.message ? err.message : String(err);
					alert(`Error creating chart: ${msg}`);
					console.error(err);
				}
			});

        })

    </script>
</body>
</html>