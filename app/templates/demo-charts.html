<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Visualization API Demo</title>
    <link rel="stylesheet" href="/static/animations.css">
    <link rel="stylesheet" href="/static/demo.css">
    <style>
        #link-preview-wrap {
            position: sticky;
            top: -20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
            padding: 20px;
            margin: -20px;
            border-bottom: solid 1px #ddd;
        }
        #link-preview-wrap .btn-wrap {
            margin-top: 0;
        }

        #generate-data-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 0;
        }
        #generate-data-section label {
            margin: 10px 0 15px 0;

        }
        #generate-data-section select {
            margin-top: 5px;
        }

        #data-preview {
            height: 200px;
            font-size: 0.7rem;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="demo-container">
            <div id="control-panel" class="control-panel">
                <h1>Chart Visualization API Demo</h1>

                <div id="link-preview-wrap">
                    <div id="url-preview">
                        <pre id="url-preview-text"></pre>
                        <button class="copy-btn" id="copy-url-btn" type="button" style="display:none">Copy</button>
                    </div>
                    
                    <div class="btn-wrap">
                        <button id="open-btn" type="button" disabled>Open URL</button>
                        <button type="submit" id="update-btn" class="shake" disabled>Update</button>
                    </div>
                </div>

                {# <div class="example-section"></div> #}

                <h3>Generate Chart Data</h3>
                <div id="generate-data-section">
                    <select id="chart-type-dropdown">
                        <option value="1" data-url="/generate/bar" data-chart-type="bar">Bar chart</option>
                        <option value="2" data-url="/generate/line" data-chart-type="line">Line chart</option>
                        <option value="3" data-url="/generate/scatter" data-chart-type="scatter">Scatter plot</option>
                        <option value="4" data-url="/generate/bubble" data-chart-type="bubble">Bubble chart</option>
                        <option value="5" data-url="/generate/pie" data-chart-type="pie">Pie chart</option>
                        <option value="6" data-url="/generate/boxplot" data-chart-type="boxplot">Box plot basic</option>
                        <option value="7" data-url="/generate/boxplot-group" data-chart-type="boxplot">Box plot grouped</option>
                        <option value="8" data-url="/generate/histogram" data-chart-type="histogram" data-params="{}">Histogram chart</option>
                    </select>

                    <label id="bar-options" style="display:none">
                        Bar chart options
                        <select class="chart-option">
                            <option value='{"h":null}'>Vertical (default)</option>
                            <option value='{"h":1}'>Horizontal</option>
                        </select>
                        <select class="chart-option">
                            <option value='{"barmode":null}'>Group (default)</option>
                            <option value='{"barmode":"stack"}'>Stacked</option>
                            {# <option value='{"barmode":"overlay"}'>Overlay</option> #}
                            {# <option value='{"barmode":"relative"}'>Relative</option> #}
                        </select>
                    </label>
                    <label id="line-options" style="display:none">
                        Line chart options
                        <select class="chart-option">
                            <option value='{"h":null}'>Vertical (default)</option>
                            <option value='{"h":1}'>Horizontal</option>
                        </select>
                    </label>
                    <label id="boxplot-options" style="display:none">
                        Boxplot options
                        <select class="chart-option">
                            <option value='{"h":null}'>Vertical (default)</option>
                            <option value='{"h":1}'>Horizontal</option>
                        </select>
                        <select class="chart-option">
                            <option value='{"show_points":null}'>Exclude data points (default)</option>
                            <option value='{"show_points":1}'>Show data points</option>
                        </select>
                        <select class="chart-option">
                            <option value='{"boxmean":null}'>Exclude deviation (default)</option>
                            <option value='{"boxmean":1}'>Include mean deviation</option>
                            <option value='{"boxmean":"sd"}'>Include mean & standard deviation</option>
                        </select>
                    </label>
                    <!-- Apply button removed: example is generated when dropdown changes (and on initial load) -->
                

                    <textarea id="data-preview">Data will appear here</textarea>
                    
                    <!-- changed to type="button" so it doesn't trigger the form submit handler -->
                    <button type="submit" id="generate-chart-btn" style="width:100%; display:none">Generate chart</button>

                </div>
                
                <form id="chart-form">
                    <h3>Display Options</h3>
 					<div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" name="title" value="Demo Chart" />
                    </div>

                    <div class="form-group">
                        <label for="subtitle">Subtitle:</label>
                        <input type="text" id="subtitle" name="subtitle" value="Some subtitle" />
                    </div>

                    <div class="form-group">
                        <label for="body">Body:</label>
                        <textarea id="body" name="body" rows="4">Hello world</textarea>
                    </div>

                    <!-- Added axis titles / prefixes / suffixes -->
                    <div class="form-group">
                        <label for="x_title">X axis title:</label>
                        <input type="text" id="x_title" name="x_title" value="" />
                    </div>

                    <div class="form-group">
                        <label for="y_title">Y axis title:</label>
                        <input type="text" id="y_title" name="y_title" value="" />
                    </div>

                    <div class="form-group">
                        <label for="x_prefix">X axis prefix:</label>
                        <input type="text" id="x_prefix" name="x_prefix" value="" />
                    </div>

                    <div class="form-group">
                        <label for="y_prefix">Y axis prefix:</label>
                        <input type="text" id="y_prefix" name="y_prefix" value="" />
                    </div>

                    <div class="form-group">
                        <label for="x_suffix">X axis suffix:</label>
                        <input type="text" id="x_suffix" name="x_suffix" value="" />
                    </div>

                    <div class="form-group">
                        <label for="y_suffix">Y axis suffix:</label>
                        <input type="text" id="y_suffix" name="y_suffix" value="" />
                    </div>

                    <h3>Rendering Options</h3>
                    <div class="form-group">
                        <label for="width">Width (pixels):</label>
                        <input type="text" id="width" name="width" value="" />
                    </div>

                    <div class="form-group">
                        <label for="height">Height (pixels):</label>
                        <input type="text" id="height" name="height" value="" />
                    </div>

                    <div class="form-group">
                        <label for="omit_legend">Omit legend:</label>
                        <select id="omit_legend" name="omit_legend">
                            <option value="">No</option>
                            <option value="1">Yes</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="output">Output:</label>
                        <select id="output" name="output">
                            <option value="" selected>HTML</option>
                            <option value="png">PNG</option>
                            <option value="svg">SVG</option>
                        </select>
                    </div>

                    <div class="form-group" id="scale-option" style="display:none">
                        <label for="scale">PNG Scale:</label>
                        <input type="number" id="scale" name="scale" value="2" min="1" />
                    </div>
                </form>
            </div>

            <div class="preview-panel">
                <iframe id="preview-frame" title="Chart Visualization"></iframe>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const previewFrame = document.getElementById('preview-frame');
            const urlPreview = document.getElementById('url-preview');
            const urlPreviewText = document.getElementById('url-preview-text');
            const btnCopyUrl = document.getElementById('copy-url-btn');
            const btnOpen = document.getElementById('open-btn');
            const btnUpdate = document.getElementById('update-btn');
            
            const chartTypeDropdown = document.getElementById('chart-type-dropdown');
            const dataPreview = document.getElementById('data-preview');
            const generateBtn = document.getElementById('generate-chart-btn');
            
            const form = document.getElementById('chart-form');
            const scaleOption = document.getElementById('scale-option');

            /**
             * Initiation
             */

            // Display default chart on page load
            displayDefaultChart()
            async function displayDefaultChart() {
                const selectedOption = chartTypeDropdown.children[0];
                await fetchDummyData(selectedOption)
                generateChart()
            }

            /**
             * Dummy data
             */

 			// Dropdown: Chart type
            // --> Generate data
 			chartTypeDropdown.addEventListener('change', () => {
 				const opt = chartTypeDropdown.options[chartTypeDropdown.selectedIndex];
 				// Clear previous URL preview and hide open buttons when selecting a new example
				urlPreviewText.textContent = ''
				btnOpen.disabled = true
                generateBtn.style.display = 'inline-block'
				fetchDummyData(opt);
 			});

            // Fetch dummy data
            async function fetchDummyData(opt) {
 				if (!opt) return;
                
 				// Derive chart type from data-url (e.g. "/generate/bar" -> "bar")
 				const urlPath = opt.dataset.url;
 				const parts = urlPath.split('/').filter(Boolean);
 				const chartType = parts.length ? parts.pop() : 'bar';

                // update visibility of option panels for this chart type
                _toggleChartOptions(chartType);

                // Compose URL
                let url = `/generate/${encodeURIComponent(chartType)}`

 				// Fetch generated example JSON
 				try {
 					const resp = await fetch(url);
 					const json = await resp.json();
 					// Display JSON with indent=2
                    dataPreview.value = JSON.stringify(json, null, 2);
 				} catch (err) {
					const errMsg = `Error fetching example for "${chartType}": ${err.message || err}`;
					if (urlPreviewText) urlPreviewText.textContent = errMsg; else urlPreviewText.textContent = errMsg;
 				}
 				// Ensure copy button remains available
				if (!urlPreview.contains(btnCopyUrl)) urlPreview.appendChild(btnCopyUrl);
 			}
            
            // Toggle chart option panels based on chart type
			function _toggleChartOptions(chartType) {
				const barOpts = document.getElementById('bar-options');
				const lineOpts = document.getElementById('line-options');
				const boxOpts = document.getElementById('boxplot-options');
				// If elements missing, do nothing
				if (!barOpts || !lineOpts || !boxOpts) return;
				barOpts.style.display = (chartType === 'bar') ? 'block' : 'none';
				lineOpts.style.display = (chartType === 'line') ? 'block' : 'none';
				boxOpts.style.display = (chartType === 'boxplot' || chartType === 'boxplot-group') ? 'block' : 'none';
			}

            /**
             * Chart options
             */

            // Dropdowns: Chart options
            // --> Update URL preview with appropriate parameters
            // --> Enable the 'Update' button
            const chartOptionDropdowns = document.querySelectorAll('#bar-options select, #line-options select, #boxplot-options select')
            Array.from(chartOptionDropdowns).forEach((optDropdown) => initOptDropdown(optDropdown))
			function initOptDropdown(optDropdown) {
				optDropdown.addEventListener('change', () => {
                    // Show "Update" buttons (only if preview URL present)
                    if (urlPreviewText.textContent) {
                        btnUpdate.disabled = false
                    }

					const val = (optDropdown.value || '').trim();
					// Do nothing if no value or no preview URL
					if (!val) return;
					const currentUrl = urlPreviewText && urlPreviewText.textContent ? urlPreviewText.textContent.trim() : '';
					if (!currentUrl) return;

					// Parse JSON from the select value
					let json;
					try {
						json = JSON.parse(val);
					} catch (err) {
						console.error('Invalid JSON in select value', err);
						return;
					}

					// Parse current preview URL and merge query params
					try {
						const url = new URL(currentUrl);
						const qParams = new URLSearchParams(url.search);
						for (const k in json) {
							// Convert value to string, ignore empty/null values
                            const v = json[k] ? String(json[k]) : undefined
                            if (json[k]) {
							    qParams.set(k, String(json[k]));
                            } else {
                                qParams.delete(k)
                            }
						}
						url.search = qParams.toString();
						urlPreviewText.textContent = url.toString();
						if (!urlPreview.contains(btnCopyUrl)) urlPreview.appendChild(btnCopyUrl);
					} catch (err) {
						console.error('Invalid URL in preview, cannot apply params', err);
						return;
					}
				});
			}

            // Gather option select params (bar/line/boxplot) and return as plain object with string values
			function _gatherOptionParams() {
				const ids = ['bar-options', 'line-options', 'boxplot-options'];
				const out = {};
				for (const id of ids) {
					const el = document.getElementById(id);
					if (!el) continue;
					const v = (el.value || '').trim();
					if (!v) continue;
					try {
						const obj = JSON.parse(v);
						for (const k in obj) {
							// ensure it's a string for URLSearchParams
							out[k] = String(obj[k]);
						}
					} catch (err) {
						// invalid JSON in select value — ignore that select
						console.error(`Invalid JSON in ${id}:`, err);
					}
				}
				return out;
			}

            /**
             * Display & Rendering options
             */
            
            // Input: 
            // --> Enable 'Update' button on edit
            form.addEventListener('input', () => {
                // Toggle PNG scale only if output is 'png'
 				const output = document.getElementById('output').value;
 				if (output === 'png') {
 					scaleOption.style.display = 'block';
 				    const controlPanel = document.getElementById('control-panel')
 					controlPanel.scrollTo(0, controlPanel.scrollHeight);
 				} else {
 					scaleOption.style.display = 'none';
 				}

                // Show shaking "Update" buttons
                if (urlPreviewText.textContent) {
                    btnUpdate.disabled = false
                }
            })

            /**
             * URL preview
             */

            // Button: Open URL
            // --> Open URL in new window
            btnOpen.addEventListener('click', openUrl)
            function openUrl(e) {
                const success = updatePreview();
                if (success) {
                    const url = (urlPreviewText && urlPreviewText.textContent) ? urlPreviewText.textContent.trim() : ''
                    window.open(url)
                }
            }

            // Button: Copy URL
            // --> Copy URL to clipboard
            btnCopyUrl.addEventListener('click', () => {
                const url = (urlPreviewText && urlPreviewText.textContent) ? urlPreviewText.textContent.trim() : ''
                navigator.clipboard.writeText(url).then(() => {
                    const originalText = btnCopyUrl.textContent
                    btnCopyUrl.textContent = '✅ Copied'
                    setTimeout(() => {
                        btnCopyUrl.textContent = originalText
                    }, 2000)
                })
            })

            // Button: Update
            // --> Update the iframe with chart data
            btnUpdate.addEventListener('click', (e) => {
                btnUpdate.disabled = true
                updatePreview();
            });

            /**
             * Display chart
             */

            // Button: Generate chart
            // --> POST data to /chart/{chart_type}
            // --> Fetch & display returned URL
			generateBtn.addEventListener('click', generateChart);
            async function generateChart(e) {
				// get selected option and chart type (prefer data-chart-type)
				const opt = chartTypeDropdown.options[chartTypeDropdown.selectedIndex];
				const chartType = (opt && opt.dataset && opt.dataset.chartType) ? opt.dataset.chartType : (opt && opt.dataset && opt.dataset.url ? opt.dataset.url.split('/').filter(Boolean).pop() : 'bar');

				// read payload from textarea
				const payloadStr = (dataPreview && dataPreview.value) ? dataPreview.value.trim() : '';
				if (!payloadStr) {
					// throw an error as requested (also show an alert for UX)
					alert('No data present in the data-preview textarea.');
					throw new Error('No data present in data-preview');
				}

				// validate JSON
				let payload;
				try {
					payload = JSON.parse(payloadStr);
				} catch (err) {
					alert('Invalid JSON in data-preview textarea.');
					return;
				}

				// POST to /chart/{chart_type}
				try {
					const resp = await fetch(`/chart/${encodeURIComponent(chartType)}`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});
					if (!resp.ok) {
						const txt = await resp.text();
						throw new Error(txt || resp.statusText || 'Server error');
					}
					const json = await resp.json();
					if (json && json.url) {
						// include option dropdown params when updating preview for the generated chart
						const optionParams = _gatherOptionParams(); // <-- NEW: merge option selects into qParams
						// reuse updatePreview to show the returned url and update iframe
						updatePreview(json.url, optionParams);
                        generateBtn.style.display = 'none'
					} else {
						throw new Error('Invalid response from server');
					}
				} catch (err) {
					const msg = err && err.message ? err.message : String(err);
					alert(`Error creating chart: ${msg}`);
					console.error(err);
				}
			}
            
            // Update URL & iframe with new chart 
            function updatePreview(path=null, qParams={}) {
                // If no URL is passed, create base URL
                if (!path) {
                    let currentUrl = urlPreviewText.textContent.trim()
                    try {
                        currentUrl = new URL(currentUrl);
                        path = currentUrl.pathname;
                    } catch(err) {
                        alert('Current URL is invalid, please regenerate chart')
                        return false
                    }
                }

                // Chart input
                qParams.title = document.getElementById('title').value;
                qParams.subtitle = document.getElementById('subtitle').value;
                qParams.body = document.getElementById('body').value;
                qParams.x_title = document.getElementById('x_title').value;
                qParams.y_title = document.getElementById('y_title').value;
                qParams.x_prefix = document.getElementById('x_prefix').value;
                qParams.y_prefix = document.getElementById('y_prefix').value;
                qParams.x_suffix = document.getElementById('x_suffix').value;
                qParams.y_suffix = document.getElementById('y_suffix').value;

                // Render options
                qParams.width = document.getElementById('width').value;
                qParams.height = document.getElementById('height').value;
                qParams.output = document.getElementById('output').value;
                if (qParams.output == 'png') {
                    qParams.scale = document.getElementById('scale').value;
                }
                qParams.omit_legend = document.getElementById('omit_legend').value;

                // Chart-specific options
                const optionDropdowns = document.getElementsByClassName('chart-option')
                Array.from(optionDropdowns).forEach(dd => {
                    if (dd.parentNode.style.display != 'none') {
                        if (dd.value) {
                            const valueDict = JSON.parse(dd.value)
                            for (const key of Object.keys(valueDict)) {
                                qParams[key] = valueDict[key]
                            }
                        }
                    }
                })

                // Filter out empty/null values
                for (const key in qParams) {
                    if (!qParams[key]) delete qParams[key]
                }

                // Compile URL
                qParams = new URLSearchParams(qParams)
                qParamsStr = qParams.toString()
                if (qParamsStr) {
                    path += `?${qParamsStr}`
                }

                // Update preview URL (displayed in the <pre> to preserve indentation)
                urlPreviewText.textContent = window.location.origin + path;
                // ensure copy button remains inside container
                if (!urlPreview.contains(btnCopyUrl)) urlPreview.appendChild(btnCopyUrl);

                // Update the iframe src
                previewFrame.src = path;

                // Enable open button
                btnOpen.disabled = false

                return true
            }

        })

    </script>
</body>
</html>