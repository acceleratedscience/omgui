<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Visualization API Demo</title>
    <link rel="stylesheet" href="/static/animations.css">
    <link rel="stylesheet" href="/static/demo.css">
</head>
<body>
    <div class="container">
        <div class="demo-container">
            <div id="control-panel" class="control-panel">
                <h1>Chart Visualization API Demo</h1>

                <form id="chartForm">
                    <h3>Examples</h3>
                    <div class="example-section">
                        <h4>Bar Charts</h4>
                        <div class="example-buttons">
                            <button class="example-btn example-bar">Bar chart</button>
                            <button class="example-btn example-bar" data-params='{"h":1}'>Bar chart horizontal</button>
                            <button class="example-btn example-bar" data-params='{"barmode":"stack"}'>Bar chart stacked</button>
                        </div>
                        <h4>Line Charts</h4>
                        <div class="example-buttons">
                            <button class="example-btn example-line">Line chart</button>
                            <button class="example-btn example-line" data-params='{"h":1}'>Line chart horizontal</button>
                        </div>
                        <h4>Scatter Plots</h4>
                        <div class="example-buttons">
                            <button class="example-btn example-scatter">Scatter plot</button>
                        </div>
                        <h4>Bubble Charts</h4>
                        <div class="example-buttons">
                            <button class="example-btn example-bubble">Bubble chart</button>
                        </div>
                        <h4>Pie Charts</h4>
                        <div class="example-buttons">
                            <button class="example-btn example-pie">Pie chart</button>
                        </div>
                        <h4>Box Plots</h4>
                        <div class="example-buttons">
                            <button class="example-btn example-boxplot">Box plot basic</button>
                            <button class="example-btn example-boxplot" data-params='{"group":1}'>Box plot grouped</button>
                            <button class="example-btn example-boxplot" data-params='{"h":1}'>Box plot horizotal</button>
                            <button class="example-btn example-boxplot" data-params='{"show_points":1}'>Box plot + data points</button>
                            <button class="example-btn example-boxplot" data-params='{"boxmean":1}'>Box plot + mean deviation</button>
                            <button class="example-btn example-boxplot" data-params='{"boxmean":"sd"}'>Box plot + standard deviation</button>
                        </div>
                        <h4>Histogram Charts</h4>
                        <div class="example-buttons">
                            <button class="example-btn example-histogram">Histogram chart</button>
                            <button class="example-btn example-histogram" data-params='{"h":1}'>Histogram chart horizontal</button>
                            <button class="example-btn example-histogram" data-params='{"barmode":"stack"}'>Histogram chart stacked</button>
                        </div>
                    </div>

                    <div class="url-preview" id="urlPreview">
                        URL will appear here
                        <button class="copy-btn" id="copy-url-btn" type="button">
                            Copy
                        </button>
                    </div>
                    
                    <div class="btn-wrap">
                        <button type="submit" id="update-preview-btn-1">Update Preview</button>
                        <button id="open-btn-1">Open URL</button>
                    </div>

                    <h3>Chart Input</h3>
                    <div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" name="title" value="Demo Chart" required />
                    </div>

                    <div class="form-group">
                        <label for="subtitle">Subtitle:</label>
                        <input type="text" id="subtitle" name="subtitle" value="Some subtitle" required />
                    </div>

                    <div class="form-group">
                        <label for="body">Body:</label>
                        <textarea id="body" name="body" rows="4" required>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse molestie quam erat, suscipit fringilla turpis feugiat sit amet. Donec iaculis convallis viverra. Pellentesque vel diam et velit molestie vulputate id sed dolor. Praesent et turpis mauris. Duis eget libero pretium, laoreet sapien sed, interdum erat. Nulla pretium, nunc et ultrices scelerisque, sapien urna lacinia ex, sed venenatis magna metus id sapien. Suspendisse cursus ligula ac dolor fermentum, id maximus nisl condimentum.</textarea>
                    </div>

                    <h3>Rendering Options</h3>
                    <div class="form-group">
                        <label for="width">Width (pixels):</label>
                        <input type="text" id="width" name="width" value="auto" />
                    </div>

                    <div class="form-group">
                        <label for="height">Height (pixels):</label>
                        <input type="text" id="height" name="height" value="auto" />
                    </div>

                    <div class="form-group">
                        <label for="output">Render Type:</label>
                        <select id="output" name="output">
                            <option value="" selected>HTML</option>
                            <option value="png">PNG</option>
                            <option value="svg">SVG</option>
                        </select>
                    </div>

                    <div class="form-group" id="scale-option" style="display:none">
                        <label for="scale">PNG Scale:</label>
                        <input type="number" id="scale" name="scale" value="2" min="1" />
                    </div>

                    <div class="btn-wrap">
                        <button type="submit" id="update-preview-btn-2">Update Preview</button>
                        <button id="open-btn-2">Open URL</button>
                    </div>
                </form>
            </div>

            <div class="preview-panel">
                <iframe id="previewFrame" title="Chart Visualization"></iframe>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("chartForm");
            const previewFrame = document.getElementById("previewFrame");
            const urlPreview = document.getElementById("urlPreview");
            const copyUrlBtn = document.getElementById("copy-url-btn");
            const scaleOption = document.getElementById("scale-option");
            const datasetsContainer = document.getElementById("datasets-container");
            const updatePreviewBtn1 = document.getElementById("update-preview-btn-1");
            const updatePreviewBtn2 = document.getElementById("update-preview-btn-2");
            const openBtn1 = document.getElementById("open-btn-1");
            const openBtn2 = document.getElementById("open-btn-2");

            // Function to update the iframe with chart data
            function updatePreview(url='/r/bar', qParams={}) {
                qParams.title = document.getElementById("title").value;
                qParams.subtitle = document.getElementById("subtitle").value;
                qParams.body = document.getElementById("body").value;
                qParams.width = document.getElementById("width").value || 'auto';
                qParams.height = document.getElementById("height").value || 'auto';
                qParams.output = document.getElementById("output").value || undefined;
                qParams.scale = document.getElementById("scale").value;

                // Filter out empty values
                for (const key in qParams) {
                    if (!qParams[key]) delete qParams[key]
                }

                // Compile URL
                qParams = new URLSearchParams(qParams)
                if (qParams.toString()) url += `?${qParams.toString()}`

                // Update preview URL
                urlPreview.textContent = window.location.origin + url // .replace(/\/g\//, '/chart/');
                urlPreview.appendChild(copyUrlBtn);

                // Update the iframe src
                previewFrame.src = url;
            }

            // Copy URL button
            copyUrlBtn.addEventListener("click", () => {
                const url = urlPreview.textContent.replace("Copy", "").trim()
                navigator.clipboard.writeText(url).then(() => {
                    const originalText = copyUrlBtn.textContent
                    copyUrlBtn.textContent = "âœ… Copied"
                    setTimeout(() => {
                        copyUrlBtn.textContent = originalText
                    }, 2000)
                })
            })

            // Shake update button when inputs change (for real-time preview)
            form.addEventListener("input", () => {
                updatePreviewBtn1.classList.add('tense')
                updatePreviewBtn2.classList.add('tense')
                
                // Toggle PNG scale depending on output
                const controlPanel = document.getElementById("control-panel")
                const output = document.getElementById("output").value;
                if (output === "PNG") {
                    scaleOption.style.display = "block";
                    controlPanel.scrollTo(0, controlPanel.scrollHeight);
                } else {
                    scaleOption.style.display = "none";
                }
            })

            // Update preview buttons
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                updatePreviewBtn1.classList.remove('tense')
                updatePreviewBtn2.classList.remove('tense')
                updatePreview();
            });

            // Open URL buttons
            openBtn1.addEventListener("click", openUrl)
            openBtn2.addEventListener("click", openUrl)
            function openUrl(e) {
                const url = urlPreview.textContent.replace("Copy", "").trim()
                window.open(url)
            }

            

            // Initially update the preview with default values
            updatePreview();

            // Example buttons
            Array.from(document.getElementsByClassName("example-btn")).forEach(button => {
                button.addEventListener("click", (e) => {
                    e.preventDefault()
                    const button = e.currentTarget;
                    let url = ''

                    if (button.classList.contains("example-bar")) {
                        url = `/r/bar`
                    } else if (button.classList.contains("example-line")) {
                        url = `/r/line`
                    } else if (button.classList.contains("example-scatter")) {
                        url = `/r/scatter`
                    } else if (button.classList.contains("example-bubble")) {
                        url = `/r/bubble`
                    } else if (button.classList.contains("example-pie")) {
                        url = `/r/pie`
                    } else if (button.classList.contains("example-boxplot")) {
                        url = `/r/boxplot`
                    } else if (button.classList.contains("example-histogram")) {
                        url = `/r/histogram`
                    } else {
                        console.error("Unknown example button clicked")
                        return
                    }
                    
                    // Add query parameters based on button class
                    qParams = {}
                    if (button.dataset.params) {
                        const customParams = JSON.parse(button.dataset.params)
                        for (const key in customParams) {
                            qParams[key] = customParams[key];
                        }
                    }

                    // We use a different URL to render a grouped boxplot
                    if ('group' in qParams) {
                        url = url.replace('/boxplot', '/boxplot-group')
                    }
                    

                    // Compile URL
                    updatePreview(url, qParams)
                });
            })
        })

    </script>
</body>
</html>
