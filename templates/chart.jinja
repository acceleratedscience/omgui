{# Implementation of plotly #}

{% set subtitle = subtitle | default('x') %}
{% set body = body | default('') %}
{% set opacity = opacity | default(1) %}

{% if width %}
    {% set width = width | string + 'px' %}
{% else %}
    {% set width = 'auto' %}
{% endif %}

{% if height %}
    {% set height = height | string + 'px' %}
{% else %}
    {% set height = 'auto' %}
{% endif %}




<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Chart</title>
		<script src="https://cdn.plot.ly/plotly-3.1.0.min.js" charset="utf-8"></script>
		<script src="/static/main.js" charset="utf-8"></script>
		<style>
			@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400,600&display=swap');

			body,
			html {
				height: 100%;
			}
			body {
				margin: 60px;
				font-family: 'IBM Plex Sans', sans-serif;
				color: rgba(0,0,0,.7);
				font-size: 16px;
				font-weight: 400;
			}
			h1, h2, h3, h4 {
				margin: 0;
				margin-bottom: 20px;
				font-weight: 600;
			}
			#params {
				display: block;
				margin-bottom: 50px;
			}
			pre {
				font-size: 13px;
				white-space: break-spaces;
				line-height: 1.5;
				color: darkblue;
				background: #fafafa;
				padding: 20px;
				border-radius: 2px;
				border: solid 1px rgba(0,0,0,.1);
			}
			details {
				cursor: pointer;
				margin-bottom: 0;
			}
			details.open {
				margin-bottom: 50px;
			}
			details h3 {
				display: inline-block;
				user-select: none;
				margin: 50px 0 0 0;
			}
			details h3:hover {
				color: darkblue;
			}
			#the-chart-wrap {
				width: 100%;
				max-width: 1800px;
				margin-top: 50px;
			}
			#the-chart {
				border: solid 1px rgba(0, 0, 0, 0.1);
				box-shadow: 0 0 100px rgba(0, 0, 0, 0.1);
			}
		</style>
	</head>
	<body>
		{{ ('<h1>' + title + '</h1>') | safe if title else '' }}
		{{ ('<h2>' + subtitle + '</h2>') | safe if subtitle else '' }}
		{{ ('<p>' + body + '</p>') | safe if body else '' }}

		<small id="params">
			Width: {{ width }}<br />
			Height: {{ height }}<br />
		</small>

		<div id="the-chart-wrap" style="width: {{ width }}; height: {{ height }}">
			<div id="the-chart"></div>
		</div>
		
		<details>
			<summary><h3>Chart Data</h3></summary>
			<pre>{{ chart_data | tojson(indent=2) }}</pre>
		</details>

		<details open_>
			<summary><h3>Color Palette</h3></summary>

			<h4>Style A - Chromatic</h4>
			<div style="display:flex; flex-wrap:wrap; width:407px; gap:1px; margin-bottom:10px">
			{% for color in palette %}
				<div style="width:50px; height:50px; margin-bottom:0px; background-color:rgba({{ color[0] }},{{ color[1] }},{{ color[2] }}, 1)"></div>
			{% endfor %}
			</div>

			<h4>Style B - Chromatic</h4>
			<div style="display:flex; flex-wrap:wrap; width:407px; gap:1px; margin-bottom:10px">
			{% for color in palette %}
				<div style="width:50px; height:50px; margin-bottom:0px; background-color:rgba({{ color[0] }},{{ color[1] }},{{ color[2] }}, {{ opacity }}); border:solid 1px rgba({{ color[0] }},{{ color[1] }},{{ color[2] }}, 1); box-sizing:border-box;"></div>
			{% endfor %}
			</div>

			<h4>Style A - Mixed</h4>
			<div style="display:flex; flex-wrap:wrap; width:407px; gap:1px; margin-bottom:10px">
			{% for i in range(0,palette|length) %}
				{% set color = palette[(i * 5) % palette|length] %}
				<div style="width:50px; height:50px; margin-bottom:0px; background-color:rgba({{ color[0] }},{{ color[1] }},{{ color[2] }}, 1)"></div>
			{% endfor %}
			</div>

			<h4>Style B - Mixed</h4>
			<div style="display:flex; flex-wrap:wrap; width:407px; gap:1px; margin-bottom:10px">
			{% for i in range(0,palette|length) %}
				{% set color = palette[(i * 5) % palette|length] %}
				<div style="width:50px; height:50px; margin-bottom:0px; background-color:rgba({{ color[0] }},{{ color[1] }},{{ color[2] }}, {{ opacity }}); border:solid 1px rgba({{ color[0] }},{{ color[1] }},{{ color[2] }}, 1); box-sizing:border-box;"></div>
			{% endfor %}
			</div>
		</details>

		<script>
			// Parse data
			const chartData = {{ chart_data | tojson }}
			const inputData = {{ input_data | tojson | default(null) }}
			
			// Console message
			// https://www.w3schools.com/charsets/ref_utf_box.asp
			sep = '\u2550'.repeat(38) + '\n'
			console.log(`%c${sep}%c This chart was generated by %cOMGUI%c üò±\n%c${sep}`, 'color: #ccc', 'color: #aaa', 'font-weight: bold; color: #777', 'font-weight: normal', 'color: #ccc')
			console.groupCollapsed('%cüë®‚Äçü¶∞ Input Data', 'color: darkseagreen')
			console.log(inputData)
			console.groupEnd()
			console.groupCollapsed('%cüìà Chart Data', 'color: coral')
			console.log(chartData)
			console.groupEnd()
			console.log('\n\n')
			
			// Parse color palette
			const palette = {{ palette | tojson }}
			
			// Options
			const width = "{{ width }}"
			const height = "{{ height }}"
			const title = "{{ title if title is not none else '' }}"
			const subtitle = "{{ subtitle if subtitle is not none else '' }}"
			const body = "{{ body if body is not none else '' }}"
			const xTitle = "{{ xTitle if xTitle is not none else '' }}"
			const yTitle = "{{ yTitle if yTitle is not none else '' }}"
			const xPrefix = "{{ xPrefix if xPrefix is not none else '' }}"
			const yPrefix = "{{ yPrefix if yPrefix is not none else '' }}"
			const xSuffix = "{{ xSuffix if xSuffix is not none else '' }}"
			const ySuffix = "{{ ySuffix if ySuffix is not none else '' }}"
			const opacity = {{ opacity }}

			// Boxplot specific options
			const boxmode = "{{ boxmode if boxmode is not none else 'overlay' }}"

			// Style constants
			const colorText = "#777"
			const colorTextDark = "#444"
			const colorLine = "#CCC"
			const family = '"IBM Plex Sans", sans-serif'
			const weight = 400
			const weightBold = 600
			
			// Define the layout of the chart
			// https://plotly.com/javascript/reference/layout/
			const layout = {
				title: {
					text: title,
					font: {
						family,
						weight: weightBold,
						color: colorTextDark,
					},
					subtitle: {
						text: subtitle,
						font: {
							family,
							weight,
							color: colorText,
						},
					},
				},
				margin: {
					l: 100,
					r: 80,
					t: 100,
					b: 90,
				},
				xaxis: {
					title: {
						text: xTitle,
						standoff: 20,
					},
					rangemode: "tozero",
					rangeslider: {
						visible: false,
					},
					showline: true,
					mirror: "ticks",
					color: colorText,
					linecolor: colorLine,
					ticklen: 5,
					tickcolor: "transparent",
					tickfont: {
						family,
						weight,
					},
					hoverformat: "%d %b, %Y",
					tickprefix: xPrefix,
					ticksuffix: xSuffix,
				},
				yaxis: {
					title: {
						text: yTitle,
						standoff: 15,
					},
					rangemode: "tozero",
					showline: true,
					mirror: "ticks",
					color: colorText,
					linecolor: colorLine,
					ticklen: 5,
					tickcolor: "transparent",
					tickfont: {
						family,
						weight,	
					},
					tickprefix: yPrefix,
					ticksuffix: ySuffix,
				},
				legend: {
					orientation: "h",
					xanchor: "left",
					x: 0,
					y: 1.15,
					font: {
						family,
						weight,
						color: colorText,
					},
				},
				
				// Show hover information for all traces at a single x-coordinate
				hovermode: "x unified",
				hoverlabel: {
					bordercolor: colorLine,
					font: {
						color: colorText,
					},
				},

				// Buttons in top right hand corner
				modebar: {
					// bgcolor: "red",
				},

				// ----------------------
				// Chart-specific options
				// ----------------------

				// Boxplot chart options
				boxmode,
				
				// Histogram chart options
				barmode: "overlay",
			}

			// Chart configuration
			// https://plotly.com/javascript/configuration-options/
			const config = { responsive: true, displaylogo: false }

			// Render the chart in the div with the id "the-chart"
			Plotly.newPlot("the-chart", chartData, layout, config)
		</script>
	</body>
</html>
